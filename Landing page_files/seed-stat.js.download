// Custom Stat
window.addEventListener('load', (event) => {
  var ajax_xhttp, params, action, uri, postid;

  uri = '/wp-admin/admin-ajax.php';
  action = 'seed_stat_ajax_views';
  postid = document.querySelector('.seed-stat.-none-ga');

  if (postid) {
    var checkLocal = getWithExpiry('seed-stat-' + postid.dataset.pid);

    if (checkLocal == null) {
      params = 'action=' + action + '&post_id=' + postid.dataset.pid + '&style=' + postid.dataset.style;
      ajax_xhttp = new XMLHttpRequest();
      ajax_xhttp.open('POST', uri, true);
      ajax_xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded;');
      ajax_xhttp.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
      ajax_xhttp.setRequestHeader('Pragma', 'no-cache');
      ajax_xhttp.setRequestHeader('Expires', '0');

      ajax_xhttp.onload = function () {
        if (this.status >= 200 && this.status < 400) {
          setWithExpiry('seed-stat-' + postid.dataset.pid, this.response, 60000);
          if (this.response == '') {
            document.querySelector('.seed-stat.-none-ga').style.display = 'none';
          }
          document.querySelector('.seed-stat-count').innerHTML = this.response;
        } else {
          console.log('error : ' + this.status);
        }
      };
      ajax_xhttp.send(params);
    } else {
      document.querySelector('.seed-stat-count').innerHTML = checkLocal;
    }
  }
});

function setWithExpiry(key, value, ttl) {
  const now = new Date();
  const item = {
    value: value,
    expiry: now.getTime() + ttl,
  };

  localStorage.setItem(key, JSON.stringify(item));
}

function getWithExpiry(key) {
  const itemStr = localStorage.getItem(key);

  if (!itemStr) {
    return null;
  }

  const item = JSON.parse(itemStr);
  const now = new Date();

  if (now.getTime() > item.expiry) {
    localStorage.removeItem(key);
    return null;
  }

  return item.value;
}
